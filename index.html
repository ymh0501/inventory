<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>匿名在庫マネージャー（暗号化版）</title>
<style>
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;background:#0f1115;color:#e8e8ea}
  header,footer{padding:12px;text-align:center;background:#171a22}
  h1{font-size:18px;margin:0}
  .card{max-width:700px;margin:20px auto;padding:20px;background:#171a22;border-radius:12px}
  input,button,select{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #2a2f3d;background:#0b0d12;color:#fff}
  button{cursor:pointer}
  button.primary{background:#5fb3ff;color:#021d33;font-weight:700}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:6px;border-bottom:1px solid #2a2f3d;font-size:13px}
</style>
</head>
<body>
<header><h1>匿名在庫マネージャー（暗号化版）</h1></header>

<div id="lock" class="card">
  <h2>パスワード入力</h2>
  <input id="pw" type="password" placeholder="パスワード">
  <button class="primary" onclick="unlock()">開く</button>
  <p id="msg" style="color:#ff6b6b"></p>
</div>

<div id="app" style="display:none">
  <div class="card">
    <h2>商品登録</h2>
    <input id="sku" placeholder="SKU/コード">
    <input id="refprice" type="number" placeholder="参考価格 (任意)">
    <input id="stock" type="number" placeholder="初期在庫">
    <button class="primary" onclick="addItem()">追加</button>
    <table><thead><tr><th>SKU</th><th>参考価格</th><th>在庫</th></tr></thead><tbody id="items"></tbody></table>
  </div>
  <div class="card">
    <h2>販売入力</h2>
    <select id="saleItem"></select>
    <input id="saleQty" type="number" placeholder="数量">
    <input id="salePrice" type="number" placeholder="販売単価 (必須)">
    <button class="primary" onclick="addSale()">販売追加</button>
    <table><thead><tr><th>日付</th><th>SKU</th><th>数量</th><th>単価</th></tr></thead><tbody id="sales"></tbody></table>
  </div>
</div>

<footer>データはAES-256-GCMで暗号化して保存されます</footer>

<script>
const DB_KEY="inv_encrypted_v1";
let db={items:[],sales:[]};
let password="";

async function deriveKey(pass){
  const enc=new TextEncoder();
  const base=await crypto.subtle.importKey("raw",enc.encode(pass),"PBKDF2",false,["deriveKey"]);
  return crypto.subtle.deriveKey({name:"PBKDF2",salt:enc.encode("inv-salt"),iterations:200000,hash:"SHA-256"},base,{name:"AES-GCM",length:256},false,["encrypt","decrypt"]);
}
async function encryptData(text){
  const iv=crypto.getRandomValues(new Uint8Array(12));
  const key=await deriveKey(password);
  const ct=await crypto.subtle.encrypt({name:"AES-GCM",iv},key,new TextEncoder().encode(text));
  return btoa(String.fromCharCode(...iv,...new Uint8Array(ct)));
}
async function decryptData(b64){
  const raw=Uint8Array.from(atob(b64),c=>c.charCodeAt(0));
  const iv=raw.slice(0,12),ct=raw.slice(12);
  const key=await deriveKey(password);
  const pt=await crypto.subtle.decrypt({name:"AES-GCM",iv},key,ct);
  return new TextDecoder().decode(pt);
}
async function save(){ localStorage.setItem(DB_KEY, await encryptData(JSON.stringify(db))); }
async function load(){
  const enc=localStorage.getItem(DB_KEY); if(!enc) return false;
  try{ db=JSON.parse(await decryptData(enc)); return true; }catch(e){ return false; }
}

async function unlock(){
  password=document.getElementById("pw").value;
  if(!password){document.getElementById("msg").textContent="パスワード必須";return;}
  const ok=await load();
  if(!ok && localStorage.getItem(DB_KEY)){document.getElementById("msg").textContent="パスワードが違います";return;}
  if(!ok) db={items:[],sales:[]};
  document.getElementById("lock").style.display="none";
  document.getElementById("app").style.display="block";
  render();
}

function addItem(){
  const sku=document.getElementById("sku").value.trim();
  const ref=parseFloat(document.getElementById("refprice").value)||0;
  const st=parseInt(document.getElementById("stock").value)||0;
  if(!sku)return alert("SKU必須");
  db.items.push({id:crypto.randomUUID(),sku,ref,stock:st});
  document.getElementById("sku").value=document.getElementById("refprice").value=document.getElementById("stock").value="";
  render(); save();
}
function addSale(){
  const id=document.getElementById("saleItem").value;
  const qty=parseInt(document.getElementById("saleQty").value)||0;
  const price=parseFloat(document.getElementById("salePrice").value);
  if(!id||qty<=0||!price) return alert("数量と単価必須");
  const item=db.items.find(i=>i.id===id); if(!item)return;
  item.stock=(item.stock||0)-qty;
  db.sales.push({date:new Date().toISOString().slice(0,10),sku:item.sku,qty,price});
  document.getElementById("saleQty").value=document.getElementById("salePrice").value="";
  render(); save();
}
function render(){
  document.getElementById("items").innerHTML=db.items.map(i=>`<tr><td>${i.sku}</td><td>${i.ref}</td><td>${i.stock}</td></tr>`).join("");
  document.getElementById("saleItem").innerHTML=db.items.map(i=>`<option value="${i.id}">${i.sku} (在庫:${i.stock})</option>`).join("");
  document.getElementById("sales").innerHTML=db.sales.map(s=>`<tr><td>${s.date}</td><td>${s.sku}</td><td>${s.qty}</td><td>${s.price}</td></tr>`).join("");
}
</script>
</body>
</html>
